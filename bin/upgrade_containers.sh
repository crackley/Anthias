#!/bin/bash -e

# vim: tabstop=4 shiftwidth=4 softtabstop=4
# -*- sh-basic-offset: 4 -*-

# Export various environment variables
export MY_IP=$(ip -4 route get 8.8.8.8 | awk {'print $7'} | tr -d '\n')
TOTAL_MEMORY_KB=$(grep MemTotal /proc/meminfo | awk {'print $2'})

# Scale memory allocations based on available RAM
if [ "$TOTAL_MEMORY_KB" -lt 1500000 ]; then
    # 1GB RAM: constrain all containers to prevent OOM
    export VIEWER_MEMORY_LIMIT_KB=$(echo "$TOTAL_MEMORY_KB * 0.40" | bc | cut -d'.' -f1)
    export SHM_SIZE_KB=$(echo "$TOTAL_MEMORY_KB * 0.15" | bc | cut -d'.' -f1)
    export SERVER_MEMORY_LIMIT_KB=$(echo "$TOTAL_MEMORY_KB * 0.15" | bc | cut -d'.' -f1)
    export CELERY_MEMORY_LIMIT_KB=$(echo "$TOTAL_MEMORY_KB * 0.10" | bc | cut -d'.' -f1)
    export CELERY_CONCURRENCY=1
else
    export VIEWER_MEMORY_LIMIT_KB=$(echo "$TOTAL_MEMORY_KB * 0.8" | bc | cut -d'.' -f1)
    export SHM_SIZE_KB=$(echo "$TOTAL_MEMORY_KB * 0.3" | bc | cut -d'.' -f1)
    export SERVER_MEMORY_LIMIT_KB=262144
    export CELERY_MEMORY_LIMIT_KB=262144
    export CELERY_CONCURRENCY=2
fi
GIT_BRANCH="${GIT_BRANCH:-master}"
export GITHUB_REPO="${GITHUB_REPO:-Screenly/Anthias}"
export GIT_BRANCH

MODE="${MODE:-pull}"
if [[ ! "$MODE" =~ ^(pull|build)$ ]]; then
    echo "Invalid mode: $MODE"
    echo "Usage: MODE=(pull|build) $0"
    exit 1
fi

# The `getmac` module might exit with non-zero exit code if no MAC address is found.
set +e
export MAC_ADDRESS=`${HOME}/installer_venv/bin/python -m getmac`
set -e

if [ -z "$DOCKER_TAG" ]; then
    export DOCKER_TAG="latest"
fi

# Detect Raspberry Pi version
if [ ! -f /proc/device-tree/model ] && [ "$(uname -m)" = "x86_64" ]; then
    export DEVICE_TYPE="x86"
elif grep -qF "Raspberry Pi 5" /proc/device-tree/model || grep -qF "Compute Module 5" /proc/device-tree/model; then
    export DEVICE_TYPE="pi5"
elif grep -qF "Raspberry Pi 4" /proc/device-tree/model || grep -qF "Compute Module 4" /proc/device-tree/model; then
    if [ "$(getconf LONG_BIT)" = "64" ]; then
        if [ "$GIT_BRANCH" = "master" ]; then
            export DEVICE_TYPE="pi4-64"
        else
            # Remove 'v' prefix if present for version comparison
            VERSION_NUM=${GIT_BRANCH#v}
            if printf '%s\n' "$VERSION_NUM" "0.19.5" | sort -V -C; then
                export DEVICE_TYPE="pi4"
            else
                export DEVICE_TYPE="pi4-64"
            fi
        fi
    else
        export DEVICE_TYPE="pi4"
    fi
elif grep -qF "Raspberry Pi 3" /proc/device-tree/model || grep -qF "Compute Module 3" /proc/device-tree/model; then
    export DEVICE_TYPE="pi3"
elif grep -qF "Raspberry Pi 2" /proc/device-tree/model; then
    export DEVICE_TYPE="pi2"
else
    # If all else fail, assume pi1
    export DEVICE_TYPE="pi1"
fi

if [[ -n $(docker ps | grep srly-ose) ]]; then
    # @TODO: Rename later
    set +e
    docker container rename srly-ose-wifi-connect anthias-wifi-connect
    docker container rename srly-ose-server anthias-server
    docker container rename srly-ose-viewer anthias-viewer
    docker container rename srly-ose-celery anthias-celery
    docker container rename srly-ose-websocket anthias-websocket
    docker container rename srly-ose-nginx anthias-nginx
    set -e
fi

cat /home/${USER}/screenly/docker-compose.yml.tmpl \
    | envsubst \
    > /home/${USER}/screenly/docker-compose.yml

if [[ "$DEVICE_TYPE" =~ ^(x86|pi5)$ ]]; then
    sed -i '/devices:/ {N; /\n.*\/dev\/vchiq:\/dev\/vchiq/d}' \
        /home/${USER}/screenly/docker-compose.yml
fi

sudo -E docker compose \
    -f /home/${USER}/screenly/docker-compose.yml \
    ${MODE}

# Build the server image from source to include local code changes.
# This overrides the pulled upstream server image with one built from
# the local repo, ensuring JS/Python/migration changes take effect.
echo "Building anthias-server image from source..."

SERVER_BUILD_DIR="/home/${USER}/screenly"
GIT_HASH=$(cd "$SERVER_BUILD_DIR" && git rev-parse HEAD)
GIT_SHORT_HASH=$(cd "$SERVER_BUILD_DIR" && git rev-parse --short HEAD)
GIT_BRANCH_LOCAL=$(cd "$SERVER_BUILD_DIR" && git rev-parse --abbrev-ref HEAD)

# Determine base image for device type
case "$DEVICE_TYPE" in
    x86)     BASE_IMAGE="debian" ;;
    pi5)     BASE_IMAGE="balenalib/raspberrypi5-debian" ;;
    pi4*)    BASE_IMAGE="balenalib/raspberrypi3-debian" ;;
    pi3)     BASE_IMAGE="balenalib/raspberrypi3-debian" ;;
    *)       BASE_IMAGE="balenalib/raspberry-pi" ;;
esac

SERVER_IMAGE="screenly/anthias-server:${DOCKER_TAG}-${DEVICE_TYPE}"

cat > "${SERVER_BUILD_DIR}/docker/Dockerfile.server" <<DOCKERFILE
# syntax=docker/dockerfile:1.4
# Auto-generated by upgrade_containers.sh â€” do not edit directly.

FROM debian:bookworm AS node-builder

RUN apt-get update && \\
    apt-get -y install \\
        curl \\
        ca-certificates && \\
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \\
    apt-get -y install nodejs

RUN mkdir -p /app
WORKDIR /app

COPY package.json \\
    package-lock.json \\
    webpack.prod.js \\
    webpack.common.js \\
    tsconfig.json \\
    /app/
RUN npm install

COPY ./static/sass/*.scss /app/static/sass/
COPY ./static/src/ /app/static/src/
ENV NODE_OPTIONS="--max-old-space-size=512"
RUN npm run build

FROM ${BASE_IMAGE}:bookworm

RUN apt-get update && \\
    apt-get -y install --no-install-recommends \\
        build-essential \\
        cec-utils \\
        curl \\
        ffmpeg \\
        git \\
        git-core \\
        ifupdown \\
        libcec-dev \\
        libffi-dev \\
        libssl-dev \\
        libzmq3-dev \\
        libzmq5-dev \\
        libzmq5 \\
        lsb-release \\
        mplayer \\
        net-tools \\
        procps \\
        psmisc \\
        python3-dev \\
        python3-gi \\
        python3-pil \\
        python3-pip \\
        python3-setuptools \\
        python3-simplejson \\
        python-is-python3 \\
        sudo \\
        sqlite3

RUN c_rehash

RUN pip3 install --upgrade pip --break-system-packages && \\
    pip3 install wheel --break-system-packages

COPY requirements/requirements.txt /tmp/requirements.txt
RUN pip3 install -r /tmp/requirements.txt --break-system-packages

RUN mkdir -p /usr/src/app
COPY . /usr/src/app/
WORKDIR /usr/src/app

COPY --from=node-builder \\
    /app/static/dist/ \\
    /usr/src/app/static/dist/

ENV GIT_HASH=${GIT_HASH}
ENV GIT_SHORT_HASH=${GIT_SHORT_HASH}
ENV GIT_BRANCH=${GIT_BRANCH_LOCAL}
ENV DEVICE_TYPE=${DEVICE_TYPE}

CMD ["bash", "bin/start_server.sh"]
DOCKERFILE

# Ensure swap is available for the build (webpack needs ~500MB heap)
CREATED_SWAP=0
if [ ! -f /swapfile ] && [ "$(free -m | awk '/Swap:/{print \$2}')" -lt 512 ]; then
    echo "No swap detected. Creating 1GB swap file for build..."
    sudo fallocate -l 1G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    CREATED_SWAP=1
fi

# Stop viewer to free memory for the build
STOPPED_VIEWER=0
if sudo docker ps --format '{{.Names}}' | grep -q anthias-viewer; then
    echo "Stopping viewer to free memory for build..."
    sudo docker stop screenly-anthias-viewer-1 || true
    STOPPED_VIEWER=1
fi

echo "Building server image (this may take 20-40 minutes on a Pi)..."
sudo docker build \
    -f "${SERVER_BUILD_DIR}/docker/Dockerfile.server" \
    -t "${SERVER_IMAGE}" \
    "${SERVER_BUILD_DIR}"

echo "Server image built: ${SERVER_IMAGE}"

if [ "$CREATED_SWAP" = "1" ]; then
    echo "Swap file created at /swapfile. To make permanent:"
    echo "  echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab"
fi

if [ -f /var/run/reboot-required ]; then
    exit 0
fi

sudo -E docker compose \
    -f /home/${USER}/screenly/docker-compose.yml \
    up -d
