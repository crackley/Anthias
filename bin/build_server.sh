#!/bin/bash -e

# Build the anthias-server Docker image from source.
# This is useful when you need code changes (Python or JS)
# to take effect without waiting for new pre-built images.
#
# Usage: bash bin/build_server.sh

cd "$(dirname "$0")/.."

GIT_HASH=$(git rev-parse HEAD)
GIT_SHORT_HASH=$(git rev-parse --short HEAD)
GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Detect device type and base image
if [ ! -f /proc/device-tree/model ] && [ "$(uname -m)" = "x86_64" ]; then
    DEVICE_TYPE="x86"
    BASE_IMAGE="debian"
elif grep -qF "Raspberry Pi 5" /proc/device-tree/model 2>/dev/null; then
    DEVICE_TYPE="pi5"
    BASE_IMAGE="balenalib/raspberrypi5-debian"
elif grep -qF "Raspberry Pi 4" /proc/device-tree/model 2>/dev/null; then
    DEVICE_TYPE="pi4"
    BASE_IMAGE="balenalib/raspberrypi3-debian"
elif grep -qF "Raspberry Pi 3" /proc/device-tree/model 2>/dev/null; then
    DEVICE_TYPE="pi3"
    BASE_IMAGE="balenalib/raspberrypi3-debian"
else
    DEVICE_TYPE="pi1"
    BASE_IMAGE="balenalib/raspberry-pi"
fi

DOCKER_TAG="latest"
IMAGE_NAME="screenly/anthias-server:${DOCKER_TAG}-${DEVICE_TYPE}"

echo "Building anthias-server for ${DEVICE_TYPE}..."
echo "  Git branch: ${GIT_BRANCH}"
echo "  Git hash:   ${GIT_SHORT_HASH}"
echo "  Base image: ${BASE_IMAGE}"
echo "  Image tag:  ${IMAGE_NAME}"

# Generate Dockerfile from the Jinja2 template without requiring Jinja2.
# This produces a pre-rendered Dockerfile equivalent to what the CI builds.
cat > docker/Dockerfile.server <<EOF
# syntax=docker/dockerfile:1.4
# Auto-generated by bin/build_server.sh â€” do not edit directly.

FROM debian:bookworm AS node-builder

RUN apt-get update && \
    apt-get -y install \
        curl \
        ca-certificates && \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get -y install nodejs

RUN mkdir -p /app
WORKDIR /app

COPY package.json \\
    package-lock.json \\
    webpack.prod.js \\
    webpack.common.js \\
    tsconfig.json \\
    /app/
RUN npm install

COPY ./static/sass/*.scss /app/static/sass/
COPY ./static/src/ /app/static/src/
ENV NODE_OPTIONS="--max-old-space-size=512"
RUN npm run build

FROM ${BASE_IMAGE}:bookworm

RUN apt-get update && \\
    apt-get -y install --no-install-recommends \\
        build-essential \\
        cec-utils \\
        curl \\
        ffmpeg \\
        git \\
        git-core \\
        ifupdown \\
        libcec-dev \\
        libffi-dev \\
        libssl-dev \\
        libzmq3-dev \\
        libzmq5-dev \\
        libzmq5 \\
        lsb-release \\
        mplayer \\
        net-tools \\
        procps \\
        psmisc \\
        python3-dev \\
        python3-gi \\
        python3-pil \\
        python3-pip \\
        python3-setuptools \\
        python3-simplejson \\
        python-is-python3 \\
        sudo \\
        sqlite3

RUN c_rehash

RUN pip3 install --upgrade pip --break-system-packages && \\
    pip3 install wheel --break-system-packages

COPY requirements/requirements.txt /tmp/requirements.txt
RUN pip3 install -r /tmp/requirements.txt --break-system-packages

RUN mkdir -p /usr/src/app
COPY . /usr/src/app/
WORKDIR /usr/src/app

COPY --from=node-builder \\
    /app/static/dist/ \\
    /usr/src/app/static/dist/

ENV GIT_HASH=${GIT_HASH}
ENV GIT_SHORT_HASH=${GIT_SHORT_HASH}
ENV GIT_BRANCH=${GIT_BRANCH}
ENV DEVICE_TYPE=${DEVICE_TYPE}

CMD ["bash", "bin/start_server.sh"]
EOF

echo "Dockerfile.server generated."

# Ensure swap is available for the build (webpack needs ~500MB heap)
if [ ! -f /swapfile ] && [ "$(free -m | awk '/Swap:/{print $2}')" -lt 512 ]; then
    echo "No swap detected. Creating 1GB swap file for build..."
    sudo fallocate -l 1G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    CREATED_SWAP=1
    echo "Swap enabled."
fi

# Stop viewer to free memory for the build
if sudo docker ps --format '{{.Names}}' | grep -q anthias-viewer; then
    echo "Stopping viewer to free memory for build..."
    sudo docker stop screenly-anthias-viewer-1 || true
    STOPPED_VIEWER=1
fi

# Build the image
echo "Building Docker image (this may take 20-40 minutes on a Pi)..."
sudo docker build \
    -f docker/Dockerfile.server \
    -t "${IMAGE_NAME}" \
    .

echo ""
echo "============================================"
echo "Build complete: ${IMAGE_NAME}"
echo "============================================"
echo ""
echo "Restart the server container with:"
echo "  sudo docker compose -f /home/\${USER}/screenly/docker-compose.yml up -d anthias-server"
echo ""
echo "Then restart nginx to reconnect:"
echo "  sudo docker restart screenly-anthias-nginx-1"

if [ "${STOPPED_VIEWER}" = "1" ]; then
    echo ""
    echo "The viewer was stopped for the build. Restart it with:"
    echo "  sudo docker start screenly-anthias-viewer-1"
fi

if [ "${CREATED_SWAP}" = "1" ]; then
    echo ""
    echo "A swap file was created at /swapfile."
    echo "To make it permanent: echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab"
fi
